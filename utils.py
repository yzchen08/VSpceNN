import torch
from torch_scatter import scatter


class MassCentre:
    def __init__(self):
        super().__init__()
        self.masses = torch.tensor([0, 1.008, 4.002602, 6.94, 9.0121831, 10.81,
                                    12.011, 14.007, 15.999, 18.998403163, 20.1797,
                                    22.98976928, 24.305, 26.9815385, 28.085, 30.973761998,
                                    32.06, 35.45, 39.948, 39.0983, 40.078,
                                    44.955908, 47.867, 50.9415, 51.9961, 54.938044,
                                    55.845, 58.933194, 58.6934, 63.546, 65.38,
                                    69.723, 72.63, 74.921595, 78.971, 79.904,
                                    83.798, 85.4678, 87.62, 88.90584, 91.224,
                                    92.90637, 95.95, 97.90721, 101.07, 102.9055,
                                    106.42, 107.8682, 112.414, 114.818, 118.71,
                                    121.76, 127.6, 126.90447, 131.293, 132.90545196,
                                    137.327, 138.90547, 140.116, 140.90766, 144.242,
                                    144.91276, 150.36, 151.964, 157.25, 158.92535,
                                    162.5, 164.93033, 167.259, 168.93422, 173.054,
                                    174.9668, 178.49, 180.94788, 183.84, 186.207,
                                    190.23, 192.217, 195.084, 196.966569, 200.592,
                                    204.38, 207.2, 208.9804, 208.98243, 209.98715,
                                    222.01758, 223.01974, 226.02541, 227.02775, 232.0377,
                                    231.03588, 238.02891, 237.04817, 244.06421, 243.06138,
                                    247.07035, 247.07031, 251.07959, 252.083, 257.09511,
                                    258.09843, 259.101, 262.11, 267.122, 268.126,
                                    271.134, 270.133, 269.1338, 278.156, 281.165, ],
                                   dtype=torch.float32)

    def centroid_coordinate(self, z, pos, batch=None):
        """
        Calculate the centre-of-mass coordinates of each atom.
        """
        mass = self.masses.cuda()[z].view(-1, 1)
        if batch is None:
            c = torch.sum(pos * mass, dim=0) / torch.sum(mass, dim=0)
            ra = (pos - c)
        else:
            c = scatter(mass * pos, batch, dim=0) / scatter(mass, batch, dim=0)
            ra = (pos - c[batch])
        return ra
